```{r Source of Inquiry and Eligibility, echo=FALSE, fig.showtext=TRUE}

#look at the number of participants who actually enrolled in the study from the source

subset_statbysource <-Master %>% select(NAME, SOURCE, STATUS) %>%
  na.omit() 

#create data frame
df <- left_join(subset_statbysource, Tracker, by = "NAME") %>%
 mutate("ELIGIBLE?" = replace_na(`ELIGIBLE?`, "NO")) %>%
  select(NAME, SOURCE, `ELIGIBLE?`) %>%
  rename(ELIG = "ELIGIBLE?")

df$SOURCE <- reorder(df$SOURCE, df$SOURCE, FUN = length)

#custom fonts for plot
font_add_google("Roboto Mono", "roboto-mono")

# lato chosen for good visability on small sreens. See https://medium.com/nightingale/choosing-a-font-for-your-data-visualization-2ed37afea637

font_add_google("Lato", "lato")

showtext_auto()

#generate plot
plot<-ggplot(df, aes(y = factor(SOURCE))) +
geom_bar(aes(fill = factor(ELIG)), width = .7) +
  scale_y_discrete(expand = expansion(mult = c(0, .1))) + #adjust the white space around the start of each bar. Think of the x-axis as stacking from bottom to top. Use x_cont since data is numerical.
#add a count for each group (the number of people per recruitment source)
  scale_x_continuous(limits = c(0, 475), expand = c(.001, .001), position = "top") +
    scale_fill_identity(guide = "none") +
  geom_text(
    stat = 'count',
    aes(label = ..count..),
    hjust = -.25,
    nudge_x = -.5,
    size = 25/.pt,
  ) +
  scale_fill_manual(
    breaks = c("YES", "NO", "UNKNOWN"),
    values = c("#008607", "#F60239", "#888888")
  ) +
  #coord_flip() + #removed coord flip as it was causing issues with controlling the placement of the x-axis label on top. Solution was to set y only. Seems to be better solution.
  labs(title = "Enrollment in the study varied by recruitment source",
      subtitle = "July 1st, 2019 - March 20th, 2020",
       fill = "Did the individual enroll in NEUROMAP?"
  ) +
  xlab("Number of people who received screening survey"
  ) +
  #change the text and other theme elements
  theme(
    text = element_text(family = "lato", size = 46),
    title = element_text(face = "bold", hjust = 0),
    plot.subtitle=element_text(face = "plain"), #manually change substitle font weight
    axis.text.y = element_text(color = "black"),
    axis.line.x = element_line(),
    axis.title.y = element_blank(),
    axis.title.x= element_text(
      face = "plain", 
      size = 25,
      #hjust = .0085, 
      #vjust = -5, 
      margin = margin(t = 18)),
    #changes size of x-axis font
    #left align title 
    plot.title.position = "plot",
    axis.text.x = element_blank(),
    
    #remove ticks
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x.top = element_line(lineend = "round"),
    
    #axis.title = element_blank(),
    
    #change legend styling
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.title = element_text(face = "plain"),
    
    #remove background
    panel.grid = element_blank(),
    panel.background = element_blank()
  )
#ggannotate()
#ragg::agg_png("ragg_5.png", width = 1980, height = 1280, units = "px", res = 300)
plot
dev.off()

#ggsave("font_title_10x10_300.png", plot = plot, height = 1280, width = 1980, units = "px", dpi = 300)

#file <- knitr::fig_path('.png')
#agg_png(pngfile, width = 60, height = 36, units = "cm", res = 300)

tab_df<- df %>% group_by(SOURCE, ELIG) %>% tally() %>%
  rename(NUM_PEOPLE = n)

datatable(tab_df)
```